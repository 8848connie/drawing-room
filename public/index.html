<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ„ åœ£è¯ç…§ç‰‡å¢™ | Merry Christmas ğŸ</title>
    <link href="https://fonts.googleapis.com/css2?family=ZCOOL+KuaiLe&family=Ma+Shan+Zheng&family=Pacifico&display=swap" rel="stylesheet">
    <style>
        :root {
            --christmas-red: #d42426;
            --christmas-green: #165b33;
            --christmas-gold: #f8b229;
            --soft-pink: #fce4ec;
            --modern-black: #2d3436;
            --sky-blue: #a2d2ff;
            --soft-blue: #bde0fe;
        }

        * {
            box-sizing: border-box;
            border-radius: 20px; /* å…¨å±€åœ†è§’é£æ ¼ */
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--soft-pink);
            color: var(--modern-black);
            overflow-x: hidden;
        }

        /* --- ç™»å½•æ³¨å†Œå°çª—å£ --- */
        #auth-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .auth-card {
            width: 400px;
            background-color: #ffffff;
            padding: 30px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.2);
            position: relative;
            /* ğŸ‘‡ ä¸‹é¢è¿™é‡Œå¯ä»¥æ›¿æ¢æˆä½ æƒ³è¦çš„ç™»å½•çª—å£èƒŒæ™¯å›¾ */
            background-image: linear-gradient(rgba(255, 182, 193, 0.8), rgba(162, 210, 255, 0.8)), 
                              url('https://unsplash.com/photos/a-picture-of-a-tree-with-purple-flowers-lViYLtWg_7M'); 
            background-size: cover;
            background-position: center;
            border: 4px solid var(--modern-black);
        }

        .auth-card h2 {
            text-align: center;
            color: var(--modern-black);
            margin-bottom: 20px;
        }

        .auth-card input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 2px solid var(--modern-black);
            background: white;
            border-radius: 15px;
        }

        .auth-card button {
            width: 100%;
            padding: 12px;
            background-color: var(--modern-black);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
            margin-top: 10px;
            transition: transform 0.2s;
        }

        .auth-card button:hover {
            transform: scale(1.05);
            background-color: var(--sky-blue);
            color: var(--modern-black);
        }

        /* --- ä¸»é¡µé¢å†…å®¹ (ç™»å½•åæ˜¾ç¤º) --- */
        #main-content {
            display: none; /* åˆå§‹éšè— */
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            padding: 40px 0;
        }

        .welcome-title {
            font-family: 'ZCOOL KuaiLe', cursive;
            font-size: 3rem;
            color: var(--christmas-red);
            margin: 0;
        }

        .welcome-subtitle {
            font-family: 'Pacifico', cursive;
            font-size: 1.5rem;
            color: var(--christmas-green);
            margin-bottom: 30px;
        }

        /* --- ç…§ç‰‡å¢™ --- */
        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 25px;
            margin-top: 40px;
        }

        .photo-card {
            background: white;
            padding: 15px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.05);
            transition: transform 0.3s ease;
            border-bottom: 5px solid var(--christmas-gold);
        }

        .photo-card:hover {
            transform: translateY(-10px) rotate(2deg);
        }

        .photo-card img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 15px;
        }

        .photo-info {
            margin-top: 10px;
            font-size: 0.9rem;
            color: var(--christmas-green);
            font-weight: bold;
        }

        /* --- ä¸Šä¼ ä¸ç•™è¨€æ¿ --- */
        .interaction-section {
            background: white;
            padding: 30px;
            margin-top: 50px;
            border: 3px dashed var(--christmas-green);
        }

        .interaction-section h3 {
            color: var(--christmas-red);
        }

        textarea {
            width: 100%;
            height: 100px;
            padding: 15px;
            border: 2px solid var(--soft-pink);
            background: #fafafa;
            margin-top: 10px;
            resize: none;
        }

        .btn-upload {
            background-color: var(--christmas-green);
            color: white;
            padding: 12px 25px;
            border: none;
            cursor: pointer;
            margin-top: 15px;
        }

        /* --- è°ƒè¯•æ—¥å¿—åŒº --- */
        #debug-panel {
            margin-top: 50px;
            background: #eee;
            padding: 15px;
            font-family: monospace;
            font-size: 12px;
            border-radius: 10px;
            border: 1px solid #ccc;
        }
    </style>
</head>
<body>

    <div id="auth-overlay">
        <div class="auth-card">
            <h2>ğŸ„ åœ£è¯æ´¾å¯¹å…¥å£</h2>
            <input type="text" id="username-input" placeholder="è¯·è¾“å…¥ä½ çš„åå­— (æ³¨å†Œå)">
            <input type="password" placeholder="è®¾ç½®ä½ çš„åœ£è¯æš—å· (å¯†ç )">
            <button onclick="handleLogin()">è¿›å…¥æ´¾å¯¹</button>
            <p style="text-align: center; font-size: 12px; margin-top: 10px; color: #555;">
                * è¿™é‡Œçš„èƒŒæ™¯å›¾å¯ä»¥åœ¨ä»£ç ä¸­æ›¿æ¢ â˜ï¸
            </p>
        </div>
    </div>

    <div id="main-content">
        <header>
            <div id="greeting-box">
                <h1 class="welcome-title" id="display-name">åœ£è¯å¿«ä¹</h1>
                <p class="welcome-subtitle" id="display-name-en">Merry Christmas!</p>
            </div>
        </header>

        <section class="interaction-section">
            <h3>ğŸ æŠ•é€’ä½ çš„åœ£è¯ç…§ç‰‡</h3>
            <form id="uploadForm">
                <input type="file" id="photo-file" accept="image/*" required>
                <button type="submit" class="btn-upload" id="submit-btn">ç«‹å³ä¸Šä¼ </button>
            </form>
            <p id="upload-status-text"></p>
        </section>

        <div class="photo-grid" id="photo-grid">
            <div class="photo-card">
                <p style="text-align:center; padding:20px;">æ­£åœ¨ä»é›ªåœ°é‡Œæ¬è¿ç…§ç‰‡...</p>
            </div>
        </div>

        <section class="interaction-section">
            <h3>ğŸ’¬ åœ£è¯ç•™è¨€æ¿</h3>
            <textarea placeholder="åœ¨è¿™é‡Œå†™ä¸‹ä½ çš„æ„¿æœ›æˆ–ç¥ç¦..."></textarea>
            <button class="btn-upload">å‘é€ç¥ç¦</button>
        </section>

        <div id="debug-panel">
            <strong>ğŸ›  ç³»ç»Ÿå®‰å…¨æ£€æŸ¥æ—¥å¿—ï¼š</strong>
            <div id="debug-log">ç­‰å¾…æ“ä½œ...</div>
        </div>
    </div>

    <script>
        let currentUserName = "";

        function logDebug(msg) {
            const log = document.getElementById('debug-log');
            log.innerHTML += `<div>[${new Date().toLocaleTimeString()}] ${msg}</div>`;
        }

        // å¤„ç†ç™»å½•é€»è¾‘
        function handleLogin() {
            const nameInput = document.getElementById('username-input').value;
            if (!nameInput) {
                alert("è¯·å…ˆè¾“å…¥åå­—å“¦ï¼");
                return;
            }
            currentUserName = nameInput;
            
            // åˆ‡æ¢é¡µé¢
            document.getElementById('auth-overlay').style.display = 'none';
            document.getElementById('main-content').style.display = 'block';
            
            // è®¾ç½®æ ‡é¢˜
            document.getElementById('display-name').textContent = `${currentUserName}ï¼Œåœ£è¯å¿«ä¹ï¼`;
            document.getElementById('display-name-en').textContent = `Merry Christmas, ${currentUserName}!`;
            
            logDebug(`ç”¨æˆ· ${currentUserName} ç™»å½•æˆåŠŸï¼Œæ­£åœ¨åŠ è½½èµ„æº...`);
            loadPhotos();
        }

        // åŠ è½½ç…§ç‰‡åˆ—è¡¨
        async function loadPhotos() {
            try {
                const res = await fetch('/.netlify/functions/get-photos');
                const data = await res.json();
                const grid = document.getElementById('photo-grid');
                grid.innerHTML = ''; // æ¸…ç©ºåŠ è½½ä¸­

                if (data.length === 0) {
                    grid.innerHTML = '<p style="grid-column: 1/-1; text-align:center;">é›ªåœ°ä¸Šè¿˜æ²¡æœ‰è„šå°ï¼Œå¿«å»ä¸Šä¼ ç¬¬ä¸€å¼ ç…§ç‰‡å§ï¼</p>';
                } else {
                    data.forEach(photo => {
                        grid.innerHTML += `
                            <div class="photo-card">
                                <img src="${photo.url}" alt="åœ£è¯ç…§ç‰‡">
                                <div class="photo-info">æ¥è‡ªï¼š${photo.name}</div>
                            </div>
                        `;
                    });
                }
                logDebug("ç…§ç‰‡å¢™æ•°æ®åŒæ­¥å®Œæˆã€‚");
            } catch (err) {
                logDebug(`âŒ åŠ è½½ç…§ç‰‡å¢™å¤±è´¥: ${err.message}`);
            }
        }

        // å¤„ç†ä¸Šä¼ é€»è¾‘
        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const fileInput = document.getElementById('photo-file');
            const submitBtn = document.getElementById('submit-btn');
            const statusText = document.getElementById('upload-status-text');

            if (!fileInput.files[0]) return;

            submitBtn.disabled = true;
            statusText.textContent = "ğŸŸ¡ æ­£åœ¨æ‰“åŒ…ç¤¼ç‰©å¹¶å¯„ç»™äº‘ç«¯...";
            logDebug("å¼€å§‹ä¸Šä¼ æµç¨‹...");

            const formData = new FormData();
            formData.append('photo', fileInput.files[0]);
            formData.append('uploader-name', currentUserName);

            try {
                const response = await fetch('/.netlify/functions/upload', {
                    method: 'POST',
                    body: formData
                });

                const rawText = await response.clone().text();
                logDebug(`æœåŠ¡å™¨å“åº”çŠ¶æ€: ${response.status}`);

                if (!response.ok) {
                    throw new Error(`æœåŠ¡å™¨æ‹’ç»äº†è¯·æ±‚: ${rawText.substring(0, 50)}`);
                }

                const result = await response.json();
                logDebug("âœ… ä¸Šä¼ æˆåŠŸï¼");
                statusText.textContent = "ğŸ‰ æˆåŠŸï¼ç…§ç‰‡å·²æŒ‚ä¸Šå¢™ã€‚";
                loadPhotos(); // åˆ·æ–°å¢™
                e.target.reset();
            } catch (err) {
                logDebug(`âŒ ä¸Šä¼ å‡ºé”™: ${err.message}`);
                statusText.textContent = "âŒ ç³Ÿç³•ï¼Œéº‹é¹¿è¿·è·¯äº†ï¼Œè¯·æ£€æŸ¥æ—¥å¿—ã€‚";
            } finally {
                submitBtn.disabled = false;
            }
        });
    </script>
</body>
</html>