<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ„ å®çš„åœ£è¯ç…§ç‰‡å¢™ ğŸ</title>
    </head>
<body>
    <header>
        <h1 id="welcome-message">åŠ è½½ä¸­...</h1>
        <p>ğŸ‰ æ¬¢è¿æ¥åˆ°æˆ‘ä»¬ä¸“å±çš„åœ£è¯å›å¿†ç©ºé—´ï¼</p>
    </header>

    <main>
        <h2>ğŸ–¼ï¸ æœ‹å‹ä»¬ä¸Šä¼ çš„ç…§ç‰‡</h2>
        <div id="photo-gallery" class="gallery">
            <p>ç…§ç‰‡åŠ è½½ä¸­...</p>
        </div>

        <hr>

        <h2>ğŸ“¸ åˆ†äº«ä½ çš„åœ£è¯ç¬é—´</h2>
        <form id="uploadForm" enctype="multipart/form-data">
            <input type="hidden" id="uploader-name" name="uploader-name"> 

            <label for="photo-file">é€‰æ‹©ç…§ç‰‡ï¼š</label>
            <input type="file" id="photo-file" name="photo" accept="image/*" required>
            
            <button type="submit" id="submit-btn">ä¸Šä¼ å¹¶åˆ†äº«</button>
            <p id="message" style="margin-top: 10px;"></p>
        </form>
    </main>

    <script>
        const UPLOAD_API_URL = '/.netlify/functions/upload';
        let globalUserName = ''; // å­˜å‚¨ä»æç¤ºæ¡†è·å–çš„åå­—

        // é¡µé¢åŠ è½½å®Œæˆåç«‹å³æ‰§è¡Œ
        document.addEventListener('DOMContentLoaded', () => {
            // 1. æ¬¢è¿æç¤ºæ¡†é€»è¾‘
            let userName = '';
            // å¾ªç¯ç›´åˆ°è¾“å…¥éç©ºåå­—
            while (userName === null || userName.trim() === '') {
                userName = prompt('è¯·è¾“å…¥æ‚¨çš„åå­—ï¼š');
                if (userName === null) {
                    userName = 'æœ‹å‹';
                    break;
                }
            }
            
            globalUserName = userName; // å­˜å‚¨åˆ°å…¨å±€å˜é‡
            
            // å°†åå­—æ˜¾ç¤ºåœ¨æ¬¢è¿è¯­ä¸­
            document.getElementById('welcome-message').textContent = `${globalUserName} åœ£è¯å¿«ä¹ï¼`;
            
            // å°†åå­—è®¾ç½®åˆ°éšè—çš„è¡¨å•å­—æ®µä¸­ï¼Œä»¥ä¾¿ä¸Šä¼ æ—¶ä¸€åŒå‘é€
            document.getElementById('uploader-name').value = globalUserName;

            // 2. ç›‘å¬ä¸Šä¼ è¡¨å•
            document.getElementById('uploadForm').addEventListener('submit', handleUpload);
            
            // 3. åˆå§‹åŠ è½½ç…§ç‰‡ï¼ˆæš‚æ—¶çœç•¥ï¼Œç­‰æ‚¨å®Œæˆ get-photos å‡½æ•°åå†æ·»åŠ ï¼‰
            // loadPhotos(); 
        });

        // å¤„ç†ä¸Šä¼ é€»è¾‘
        async function handleUpload(event) {
            event.preventDefault();
            const form = event.target;
            const messageElement = document.getElementById('message');
            const submitBtn = document.getElementById('submit-btn');

            messageElement.textContent = 'æ­£åœ¨ä¸Šä¼ ä¸­ï¼Œè¯·ç¨å€™...';
            submitBtn.disabled = true; // ä¸Šä¼ ä¸­ç¦ç”¨æŒ‰é’®

            try {
                // FormData ä¼šè‡ªåŠ¨åŒ…å«éšè—çš„ 'uploader-name' å­—æ®µå’Œ 'photo' æ–‡ä»¶
                const response = await fetch(UPLOAD_API_URL, {
                    method: 'POST',
                    body: new FormData(form) // å‘é€è¡¨å•æ•°æ®ï¼Œæ— éœ€æ‰‹åŠ¨æ·»åŠ  Content-Type
                });

                // æ£€æŸ¥å“åº”çŠ¶æ€ç æ˜¯å¦åœ¨ 200-299 èŒƒå›´å†…
                const result = await response.json(); 

                if (response.ok) {
                    // åç«¯è¿”å›çš„ JSON ä¸­åº”è¯¥æœ‰ name å­—æ®µ
                    const uploaderName = result.name || globalUserName; 
                    messageElement.textContent = `ğŸ‰ ä¸Šä¼ æˆåŠŸï¼æ„Ÿè°¢ ${uploaderName} çš„åˆ†äº«ï¼ (URL: ${result.url})`;
                    
                    // æ¨¡æ‹Ÿå®æ—¶åˆ·æ–°ï¼šå°†æ–°ä¸Šä¼ çš„å›¾ç‰‡æ·»åŠ åˆ°å±•ç¤ºåŒºé¡¶éƒ¨
                    appendPhotoToGallery(result.url, uploaderName, true);

                    form.reset();
                } else {
                    // åç«¯ï¼ˆupload.jsï¼‰ä¼šè¿”å›åŒ…å«é”™è¯¯ä¿¡æ¯çš„ JSON
                    // æ¯”å¦‚: { msg: 'ä¸Šä¼ å¤„ç†å¤±è´¥', error: 'æ–‡ä»¶è§£æå¤±è´¥' }
                    throw new Error(result.error || result.msg || 'ä¸Šä¼ å¤±è´¥ï¼Œåç«¯æœåŠ¡è¿”å›é”™è¯¯ã€‚');
                }

            } catch (error) {
                // æ•è·æ‰€æœ‰ç½‘ç»œé”™è¯¯æˆ–æ‰‹åŠ¨æŠ›å‡ºçš„é”™è¯¯
                messageElement.textContent = `âŒ é”™è¯¯: ${error.message}`;
                console.error('ä¸Šä¼ è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯:', error);
            } finally {
                submitBtn.disabled = false; // é‡æ–°å¯ç”¨æŒ‰é’®
            }
        }
        
        // è¾…åŠ©å‡½æ•°ï¼šå°†å›¾ç‰‡æ·»åŠ åˆ° DOM
        function appendPhotoToGallery(url, name, prepend = false) {
            const photoGallery = document.getElementById('photo-gallery');
            if (!photoGallery) return;

            const photoDiv = document.createElement('div');
            photoDiv.className = 'photo-item'; // å¯ä»¥ç”¨æ¥å†™ CSS æ ·å¼

            const imgElement = document.createElement('img');
            imgElement.src = url;
            imgElement.alt = `${name} çš„åœ£è¯ç…§ç‰‡`;
            imgElement.style.maxWidth = '300px'; // ä¸´æ—¶æ ·å¼ï¼Œæ–¹ä¾¿æŸ¥çœ‹

            const caption = document.createElement('p');
            caption.textContent = `æ¥è‡ª: ${name}`;

            photoDiv.appendChild(imgElement);
            photoDiv.appendChild(caption);

            if (prepend && photoGallery.firstChild) {
                photoGallery.insertBefore(photoDiv, photoGallery.firstChild);
            } else {
                photoGallery.appendChild(photoDiv);
            }
        }
    </script>
</body>
</html>