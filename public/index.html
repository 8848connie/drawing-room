<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ„ å®çš„åœ£è¯ç…§ç‰‡å¢™ ğŸ</title>
  <title>ğŸ Christmas photo wall </title>
    </head>
<body>
    <header>
        <h1 id="welcome-message">åŠ è½½ä¸­...</h1>
        <p>ğŸ‰ æ¬¢è¿æ¥åˆ°æˆ‘ä»¬ä¸“å±çš„åœ£è¯å›å¿†ç©ºé—´ï¼</p>
    </header>

    <main>
        <h2>ğŸ–¼ï¸ æœ‹å‹ä»¬ä¸Šä¼ çš„ç…§ç‰‡</h2>
        <div id="photo-gallery" class="gallery">
            <p>ç…§ç‰‡åŠ è½½ä¸­...</p>
        </div>

        <hr>

        <h2>ğŸ“¸ åˆ†äº«ä½ çš„åœ£è¯ç¬é—´</h2>
        <form id="uploadForm" enctype="multipart/form-data">
            <input type="hidden" id="uploader-name" name="uploader-name"> 

            <label for="photo-file">é€‰æ‹©ç…§ç‰‡ï¼š</label>
            <input type="file" id="photo-file" name="photo" accept="image/*" required>
            
            <button type="submit" id="submit-btn">ä¸Šä¼ å¹¶åˆ†äº«</button>
            <p id="message" style="margin-top: 10px;"></p>
        </form>
    </main>

    <script>
       <!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ„ å®çš„åœ£è¯ç…§ç‰‡å¢™ - è°ƒè¯•æ¨¡å¼ ğŸ</title>
</head>
<body>
    <header>
        <h1 id="welcome-message">è°ƒè¯•æ¨¡å¼ï¼šä¸Šä¼ æ•…éšœåˆ†æ</h1>
    </header>

    <main>
        <h2>ğŸ“¸ åˆ†äº«ä½ çš„åœ£è¯ç¬é—´</h2>
        <form id="uploadForm" enctype="multipart/form-data">
            <input type="hidden" id="uploader-name" name="uploader-name"> 
            <label for="photo-file">é€‰æ‹©ç…§ç‰‡ï¼š</label>
            <input type="file" id="photo-file" name="photo" accept="image/*" required>
            <button type="submit" id="submit-btn">ä¸Šä¼ å¹¶åˆ†äº«</button>
            <p id="message" style="margin-top: 10px; font-weight: bold;"></p>
        </form>
        
        <div id="debug-log" style="white-space: pre-wrap; margin-top: 20px; border: 1px solid #ccc; padding: 10px; background: #f9f9f9;">
            <h3>ğŸ” è¯¦ç»†è°ƒè¯•æ—¥å¿—</h3>
            <p>ç­‰å¾…ä¸Šä¼ ...</p>
        </div>
    </main>

    <script>
        const UPLOAD_API_URL = '/.netlify/functions/upload';
        let globalUserName = 'è°ƒè¯•ç”¨æˆ·'; // å‡è®¾ä¸€ä¸ªé»˜è®¤åå­—

        document.addEventListener('DOMContentLoaded', () => {
            // ç¡®ä¿éšè—å­—æ®µæœ‰å€¼
            document.getElementById('uploader-name').value = globalUserName;
            document.getElementById('uploadForm').addEventListener('submit', handleUpload);
        });

        function logDebug(msg) {
            const debugLog = document.getElementById('debug-log');
            debugLog.innerHTML += `<p>â€” ${new Date().toLocaleTimeString()} â€” ${msg}</p>`;
            debugLog.scrollTop = debugLog.scrollHeight; // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
        }

        async function handleUpload(event) {
            event.preventDefault();
            const form = event.target;
            const messageElement = document.getElementById('message');
            const submitBtn = document.getElementById('submit-btn');
            
            // æ¸…ç†æ—§æ—¥å¿—
            document.getElementById('debug-log').innerHTML = '<h3>ğŸ” è¯¦ç»†è°ƒè¯•æ—¥å¿—</h3>';
            messageElement.textContent = 'ğŸŸ¡ æ­£åœ¨å‘é€è¯·æ±‚ï¼Œè¯·å‹¿å…³é—­...';
            submitBtn.disabled = true;

            try {
                logDebug('1. å‡†å¤‡å‘é€ FormData...');
                const formData = new FormData(form);

                // --- ç¬¬ä¸€å±‚æ£€æŸ¥ï¼šç½‘ç»œè¯·æ±‚å‘èµ· ---
                const response = await fetch(UPLOAD_API_URL, {
                    method: 'POST',
                    body: formData
                });
                
                logDebug(`2. æ”¶åˆ°å“åº”ï¼çŠ¶æ€ç : ${response.status} ${response.statusText}`);

                // --- ç¬¬äºŒå±‚æ£€æŸ¥ï¼šæ£€æŸ¥é 200/400 çŠ¶æ€ç  ---
                if (response.status !== 200 && response.status !== 400) {
                    const text = await response.text();
                    logDebug(`âŒ è‡´å‘½é”™è¯¯ï¼šçŠ¶æ€ç  ${response.status}ã€‚é€šå¸¸æ˜¯ 404/502/504 é”™è¯¯ã€‚`);
                    logDebug(`âš ï¸ åŸå§‹å“åº”ä½“ï¼ˆé JSONï¼‰ï¼š\n${text.substring(0, 500)}`); // åªæ˜¾ç¤ºå‰ 500 å­—ç¬¦
                    
                    messageElement.textContent = `âŒ é”™è¯¯ï¼šåç«¯è·¯ç”±æˆ– Function å´©æºƒã€‚çŠ¶æ€ç  ${response.status}ã€‚`;
                    return; 
                }

                // --- ç¬¬ä¸‰å±‚æ£€æŸ¥ï¼šå°è¯•è§£æ JSON ---
                logDebug('3. å°è¯•è§£æ JSON å“åº”ä½“...');
                
                // å…³é”®ç‚¹ï¼šè¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ .clone() æ¥å…‹éš†å“åº”ä½“ï¼Œ
                // ä»¥ä¾¿åœ¨è§£æå¤±è´¥æ—¶ï¼Œæˆ‘ä»¬ä»å¯ä»¥è¯»å–åŸå§‹æ–‡æœ¬ã€‚
                const jsonResponseClone = response.clone();
                let result;
                
                try {
                    result = await response.json();
                } catch (e) {
                    // å¦‚æœ JSON è§£æå¤±è´¥ï¼Œè¯»å–åŸå§‹æ–‡æœ¬ä½œä¸ºè°ƒè¯•ä¿¡æ¯
                    const text = await jsonResponseClone.text();
                    logDebug('âŒ JSON è§£æå¤±è´¥ï¼åŸå§‹é”™è¯¯ä¿¡æ¯: ' + e.message);
                    logDebug(`âš ï¸ å“åº”ä½“å¼€å¤´ï¼š\n${text.substring(0, 500)}`); // æ‰“å°å¼€å¤´å†…å®¹
                    
                    messageElement.textContent = `âŒ é”™è¯¯ï¼šFailed to execute 'json' on 'Response' (åç«¯æœªè¿”å› JSON)ã€‚`;
                    return; 
                }
                
                logDebug('4. JSON è§£ææˆåŠŸï¼');
                
                // --- ç¬¬å››å±‚æ£€æŸ¥ï¼šæ£€æŸ¥ä¸šåŠ¡é€»è¾‘çŠ¶æ€ ---
                if (response.ok) {
                    logDebug('âœ… ä¸šåŠ¡æˆåŠŸï¼šFunction è¿”å› 200 çŠ¶æ€ã€‚');
                    messageElement.textContent = `ğŸ‰ ä¸Šä¼ æˆåŠŸï¼å›¾ç‰‡ URL: ${result.url}`;
                    
                } else {
                    // response.ok ä¸º false (é€šå¸¸æ˜¯ 400 çŠ¶æ€ç )
                    logDebug(`ğŸš« ä¸šåŠ¡å¤±è´¥ï¼šFunction è¿”å›é 200 çŠ¶æ€ã€‚é”™è¯¯æ¶ˆæ¯: ${result.msg || result.error}`);
                    messageElement.textContent = `ğŸš« ä¸šåŠ¡é”™è¯¯: ${result.msg || 'ä¸Šä¼ å¤±è´¥ã€‚'}`;
                    
                }
                
                logDebug(`5. æœ€ç»ˆç»“æœå¯¹è±¡: ${JSON.stringify(result, null, 2)}`);
                
                form.reset();

            } catch (error) {
                // --- ç¬¬äº”å±‚æ£€æŸ¥ï¼šç½‘ç»œæˆ–ä»£ç è¿è¡Œæ—¶é”™è¯¯ ---
                logDebug(`ğŸ”´ æœ€ç»ˆæ•è·çš„ JavaScript/ç½‘ç»œé”™è¯¯: ${error.message}`);
                messageElement.textContent = `ğŸ”´ ä¸¥é‡é”™è¯¯ï¼šç½‘ç»œè¿æ¥æˆ–å®¢æˆ·ç«¯ä»£ç å‡ºé”™ã€‚`;
                console.error('ä¸Šä¼ è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯:', error);
            } finally {
                submitBtn.disabled = false;
            }
        }
    </script>
</body>
</html>
    </script>
</body>
</html>
